# 深入

# 基础架构

## 架构设计

### 模块化

- 高度抽象模块化
- 模块接口简单，提供高灵活性
- 配置模块的设计
- 核心模块接口简单化
- 多层次、多类别模块设计

### 事件驱动

### 多阶段异步处理

- 请求分阶段异步处理

阶段划分，阻塞方法：

- 触发事件
- 时间分解
- 定时器处理空转
- 无法划分，使用独立进程处理

### 管理进程、多工作进程

1. 利用多核
2. 负载均衡
3. 负责监控工作进程状态并负责管理其行为

### 平台无关代码设计

使用C实现Nginx时尽量减少了对操作系统的依赖

与操作系统相关代码针对不同操作系统有具体实现

### 内存池设计

避免出现内存碎片，减少向操作系统申请内存的次数，一般不负责回收内存池中已分配的空间

一个请求一个连接池

### 管道过滤模式的Http过滤模块

本质是一类Http模块，每个模块有输入和输出，具有统一的接口

依据Configure执行时决定的顺序组成流水线式的加工Http响应中心，每个过滤模块完全独立，负责接收输入，将输出传递给下一个过滤模块

### 其他用户模块

## 核心结构体

Nginx核心代码框架围绕ngx_cycle_t结构体展开，每个进程拥有一个

服务在初始化时，以ngx_cycle_t对象为中心提供服务

### ngx_listening_t

ngx_cycle_t结构体中的动态数组成员listening

每一个这个结构体代表一个nginx监听一个端口

### ngx_cycle_t

### ngx_cycle_t支持的方法

## nginx启动时框架的处理流程

1. 依据命令得到配置文件path
2. (处于升级中)监听环境变量里传递的监听句柄
3. 调用所有核心模块的create_conf方法生成存放配置项的结构体
4. 针对所有核心模块解析nginx.conf配置文件
5. 调用核心模块的init_conf
6. 创建目录，打开文件，初始化共享内存等进程间通信
7. 打开由各Nginx模块从配置文件中读取到的监听端口
8. 调用所有模块的init_moudle方法
9. 以进程方式运行Nginx
    - 以单进程方式运行-》single模式-》调用所有模块的init_process
    - 以Master多进程方式运行，多进程并发执行
        - master进程
        - worker进程-》调用init_process方法
        - cache manager进程-》cache loader子进程-》关闭父进程启动时监听的端口

第2步，调用ngx_add_inherited_sockets

第3-8步，ngx_init_cycle方法中执行

调用配置模块提供的解析配置项方法，遍历nginx.conf的所有配置项

调用核心模块的init_conf，这一步骤的目的在于让所有核心模块在解析完配置项后可以综合性处理

### worker进程工作流程

关注4个全局标志位

quit---优雅关闭

terminate---强制关闭进程

ngx_reopen---重新打开所有文件

ngx_debug_quit---目前无实际意义

### master进程工作过程

不处理网络事件，通过子进程实现重启服务，平滑升级，更换日志文件，配置文件实时生效

# 事件模块

## 定义

主要用于解决收集，管理，分发事件

## 连接

被动

由客户端发起，使用ngx_connection_t定义

主动

服务器发起，使用ngx_peer_connection_t定义

连接池

Nginx认为任何一个连接至少需要一个读事件一个写事件，有多少连接分配多少事件

如何联系读事件，写事件，连接池？

三者都由大小相同的三个数组组成，依据数组序号连接，这在ngx_event_core_moudle模块的初始化过程中决定了

## ngx_events_moudle核心

## ngx_event_core_moudle

## epoll

在内核中申请了简易文件系统，分为三种操作，create建立一个epoll对象，ctl添加套接字，wait搜集发生事件的连接

每个epoll对象有一个独立的ecentepoll结构体，这个结构体会在内存中创建独立内存，调用ctl添加的事件都会增加到rbr红黑树

## 定时器

Nginx自己实现，时间缓存在内存中

同时提供设置缓存时间的精度的设置

### 红黑树维护

红黑树，由所有定时器时间组成

## 事件框架处理流程

### 建立新链接

1. 调用accept建立新的TCP链接
2. 设置负载均衡
3. 从连接池获取ngx_connection_t结构体
4. 为链接创建内存池
5. 设置新链接套接字的属性
6. 将新链接的读事件添加到epoll中监控
7. 调用ngx_linstening_t结构体的handler方法处理链接（检查available标示位，为0则结束，为1则回到第一步）

### 解决惊群

打开accept_mutex锁

当worker都在休眠状态，这时来了一个连接，激活所有的worker这是不必要的，但激活过程触发了上下文切换，这导致了一定的不必要的消耗

Nginx处理，惊群是由于多个进程监Web端口，Nginx确保同时只有一个worker监听Web端口

### 实现负载均衡

打开accept_mutex锁

当ngx_accept_disabled < 0,不触发负载均衡

当ngx_accept_disabled > 0,进行负载均衡操作，当前进程再处理新连接事件，而是值减一

故Nginx子进程Worker间负载均衡当当前使用连接树达到总连接数的7/8时不再处理

### Post事件队列

将事件添加到队列中

## 文件异步IO

CPU与I/O，提交异步I/O操作后，进程继续工作，进程空闲后再查看是否完成

ngx_epoll_moudle中异步IO

异步IO事件完成后，句柄处于可用状态，epoll_wait返回ngx_eventfd_event事件后调用ngx_epoll_eventfd_handler处理已经完成的异步IO

# 框架初始化

### 管理Http模块的配置项

### 监听端口管理

### server的快速检索

### location的快速检索

数据结构采用二叉树

为何不用红黑树？

1. location是由nginx.conf读取到的，静态不变
2. 查找效率低于直接构建的完全平衡的二叉树

### Http请求的11个处理阶段

# Http框架执行流程

### 新建连接

### 第一次可读事件

### 接受Http请求行

### 接受Http请求头

### 处理Http请求

### subequest与post请求

### 处理Http包体

### 发送Http响应

### 结束Http请求 

# upstream机制的设计和实现

### 概述

### 启动

### 与上游建立连接

### 向上游发送请求

### 接收上游响应头部

### 不转发响应

### 转发响应（以下游网速优先转发响应）

# 邮件代理模块

### 模块框架

### 初始化请求

### 接收并解析客户端请求

### 邮件认证

### 与上游服务器间认证交互

# 进程间的通信机制

### 共享内存

### 原子操作

### Nginx频道

### 信号

### 信号量

### 文件锁

### 互斥锁