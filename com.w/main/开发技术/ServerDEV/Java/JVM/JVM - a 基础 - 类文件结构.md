# 虚拟机执行子系统

# 1.类文件结构

## 1.1 无关系

- 语言无关：Java虚拟机不与包括Java语言在内的任何语言绑定
- 文件有关：与Class文件特定二进制文件格式关联

## 1.2 类文件结构

- 任何一个Class文件对应唯一一个类或者接口的定义信息，反之不然（可由类加载器直接生成）
- 内容：
  - 8位字节为基础单位的二进制流
  - 无分隔符
  - 8位字节以上数据，高位在前分割
- Class文件格式：类似C语言体系结构的伪结构体（无符号数 + 表）
  - 表：多个无符号数 + 其它表作为数据项构成符合数据结构类型
  - 结尾：_info
- Class文件本质就是一张表
- 当需要描述统一类型但数量不定的多个数据时，使用1个前置容量计数器+若干连续数据项的形式

## 1.3 具体文件

> 工具：javap -verbose输出字节码内容

- 前4个字节：被称为魔数（Magic Number），确定文件是否为能被虚拟机接受的Class文件，值为：0xCAFEBABE

- 5-8字节：Class文件版本号，第5，6为次版本号，第7，8为主版本号

  java版本号从45开始JDK1.1之后，每个大版本+1

- 随后是常量池入口：u2类型数据，代表常量池容量计数值（constant_poll_count)，计数1开始

  - 常量池数据类型：
    - 字面量（Literal）
    - 符号引用（SymbolicReferences）
      - 类和接口的全限定名
      - 字段的名称和描述符
      - 方法的名称和描述符
  - Class文件中方法，字段引用CONSTANT_Utf8_info型常量来描述名称，最大值65535
  - java中64KB以上的英文字符的变量或方法名会无法编译

- 常量池结束后的两个字节代表访问标志位（access_flag)，共16个可用

- 类索引：u2类型数据，类全限定名，指向CONSYANT_Utf8的类描述符常量

- 父类索引：u2类型数据，父类全限定名（除java.lang.Object外，类的父类索引都不是0），指向CONSYANT_Utf8的类描述符常量

- 接口索引集合：一组u2类型数据集合，implements后的顺序排列在接口索引集合中

  - 入口第一项---u2类型数据为接口计数器，表示索引表的容量，没有接口则为0，后面接口索引表不占任何字节

- 字段表集合：接口或类中声明的变量，类级变量+实例级变量（方法内部变量不算）

  - 方法和字段描述符：描述符用来描述字段数据类型 + 方法的参数列表（数量，类型，顺序）+ 返回值
  - 描述符规则：
    - long --- J, boolean --- Z, 对象类型---L，void---V，其它为基本类型为首字母大写
    - 数组类型：每一维度一个前置[
      - 示例：java.lang.String\[]\[] => [[Ljava/lang/String
    - 描述方法：
      - 先参数列表（按严格顺序放在（）内），后返回值
      - 示例：int indexOf(char[] source, int sourceOffet,int sourceCount, char[] target, int targetOffset, int targetCount, int fromIndex) => ([CII[CIII)I

- 方法表集合：

  - 内容：访问标志，名称索引，描述符索引，属性表集合
  - 方法体内容：经编译器编译为字节码后存放在表集合中名为Code的属性里
  - 父类方法，子类中未重写，方法表集合中不存在来自父类的方法信息
  - java中重载方法要求方法与原方法有不同的特征签名（方法中各个参数在常量池中字段符号引用的集合，返回值不在其中），Class文件中描述符不完全一致的方法可以共存

- 属性表集合

  - 要求不与已有属性名重复
  - Code属性：
    - Java的方法体字节码，接口抽象类中不存在此属性
    - max_stack：操作数栈深度最大值，任何时刻不会超过这个值，虚拟机允许时依据此分配栈帧中的的操作数栈深度
    - max_local：局部变量表所需存储空间，单位Slot
      - byte,char,float,int,short,boolean,returnAddress等不超过32位---占用1Slot
      - double,long---占2Slot
      - 包括：方法参数，实例方法中隐藏的this，显示异常处理器参数（Catch块定义内容），方法体中局部变量
      - max_local 值不等于所有变量的Slot和，原因，局部变量表Slot可重用(代码执行操作局部变量作用域即后面不再使用此局部变量了，此时它的空间便可被占用)，编译器基于局部变量表作用域分配Slot
    - code_length：u4类型，虚拟机规范不得超过65535（u2),jsp文件在编译时可能由于编译器原因将代码及输出值归于一个方法导致编译失败