# network-网络互连

> ### 引入互连
>
> 网桥或交换机只能分隔冲突域，但不能分隔广播域
>
> 解决网络风暴的策略
>
> > 将广播限定在一定范围
>
> - VLAN：缺点是增加软硬件开销，vlan间通信问题
> - LAN在网络层的互连：路由器，L3交换机

# 网络层概述

## 功能

- **寻址**: 全网的数据交换需要全局统一编制，并且方便查找
- **转发**: 依据表的路由器内部数据交换。(forwarding)就是路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。
- **路由**：分组从源到目的地所经过的端到端路径，路由选择的结果。
- **路由协议**：(routing)则是按照分布式算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由。

## 实现

### 寻址

分组传递需要解决的问题

- 寻址策略
- 选路方法

### **要求**

- 不可使用MAC地址？

    为了便于全世界的网络互连，MAC地址是写死的，且是在一定范围内流转的，使用划分识别网络会使用非常复杂的硬件地址转换等，而使用IP，借由ARP协议实现 ip - MAC地址的映射是不错的选择

- 重新设计网络层地址：IP  address

> IP地址 ::= { <网络号>, <主机号>}
> 定长、可配置

### 分组转发

基于查表，采用存储转发的方法对分组进行转发：接收并缓存数据分组，提取分组中的目的地址，然后查表决定转发路径。如果没有查到，则丢弃该分组。（隔离广播）

- 转发：就是在收到分组时，根据其目的地址去查找转发表，找出该从哪一个接口将该分组发送出去；
- 转发表(forwarding table)：根据路由表构造；
- 路由表(routing table)：用路由选择算法构造，构造的过程由路由选择协议实现。

**转发表结构**：**目的网络，端口号**

> 将路由表中的下一跳映射到具体的输出端口上

**路由表结构**：**目的地，下一跳**

- 源无关：转发工作与分组的来源无关，因此转发表中不需要源站地址；
- 下一跳：网络的拓扑随时改变，任何路由器在某一时刻只能确定其直接相连的主机状态；（仅与目的网络相关）
- 目的地：站地址？网络地址？（因此IP地址是层次地址。反映网络信息）

### 路由

**直接交付**：在一个直接连接的网络上时，分组从一台主机上直接传送到另一台主机的过程
**间接交付**：不在一个直接连接的网络上时，源主机必须先把分组发给一个路由器

## 网络层设备

### 路由器

主要路由选择+分组转发

### 与交换机比较

- 交换机查转发表的方法决定转发路径，表中存放的是端口与目的MAC地址之间的关系，要用帧中的MAC地址查表；
- 路由器中的路由表存放的是端口与目的网络地址之间的关系，需要从分组中提取目的网络地址来查表。

# IPv4编址

## 接口

- P地址: 对主机、路由器接口的32-bit 标识符 
- 接口: 在主机/路由器和物理链路之间的连接
    - 路由器通常具有多个接口
    - 主机可能具有多个接口
    - IP编址与每个接口相联系

## 点分十进制记法

IP编址(IP addressing)：IP地址 ::= { <网络号>, <主机号>}

> IP地址长32 bit长，共能容纳232(约40亿)个IP地址
>
> 机器中存放的 IP 地址是 32 bit 二进制代码

处理32进制

1. 每隔 8 bit 插入一个空格以提高可读性(1........)
2. 将每 8 bit 的二进制数转换为十进制数(192 168 1 1)
3. 采用点分十进制记法则进一步提高可读性（处理到此处的IP，eg: 192.168.1.1）

## 地址演化

分类的IP地址：这是最基本的编址方法，在 1981 年就通过了相应的标准协议。

子网划分方案：这是对最基本的编址方法的改进，其标准[RFC 950]在 1985 年通过。

CIDR方案（现行）：这是比较新的无分类编址方法。1993 年提出后很快就得到推广应用。

IPv6地址（现行）：目前可以申请到的

## 地址分类

- a类地址 2^7-1 = 127- 1 = 126个，减一的原因是当后续为0 时就会和全0冲突
- b 2^15 个,c 2^23 地址个数不需要减一

![image-20200510195708862](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510195708862.png)

分类中可用的IP地址范围：

| 地址类别 | 网络号可用范围      | 主机号可用范围    |
| -------- | ------------------- | ----------------- |
| A        | 1-126               | 0.0.1-255.255.254 |
| B        | 128.0-191.255       | 0.1-255.254       |
| C        | 192.0.0-223.255.255 | 1-254             |

D：不是节点地址，不可用于主机

**特殊IP地址**

- 全0表示this；
- 全1表示广播；
- 127开头的A类地址用于“环回测试”。

| 网络号 | 主机号 | 源地址 | 目的地址 | 含义                       |
| ------ | ------ | ------ | -------- | -------------------------- |
| 0      | 0      | 可用   | 不可用   | 本网络，本主机，this       |
| 0      | 合法ID | 可用   | 不可用   | 本网络，某一个主机         |
| 合法ID | 0      | 可用   | 可用     | 某个网络                   |
| 1      | 1      | 不可用 | 可用     | 本网络内广播，路由器不转发 |
| 合法ID | 1      | 不可用 | 可用     | ID指定网络内广播           |
| 127    | 合法ID | 可用   | 可用     | 本地环回测试               |

## 划分子网

分类IP存在的问题

1. IP地址空间的利用率有时很低。
2. 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。
3. 两级的IP地址在扩展网络时不够灵活。

解决方法：划分子网

> 将物理网络进一步划分为若干独立的组成部分，每个部分称为这一网络（或更高一级子网）的子网。
>
> 对外仍表现为一个没有划分子网的网络。

什么是子网 ?subnet

- IP地址子网相同部分的设备接口
- 能够物理上互相到达而没有中间路由器

### 结果

- 划分子网不但没有解决问题,反而加剧
- 因特网主干路由表项目遽增
- IP地址耗尽或是路由表会崩溃

### 解决方法

- 长远：IPV6 128bit
- 近期：采用无分类域间路由CIDR（classless Inter -Domain Routing）缓解
    RFC 1517-1520

## 无类别域间路由选择

> (Classless InterDomain Routing, CIDR)

把一块相邻接的IP地址压缩成一个表项

**结构**： IP地址 ::= { <网络地址>/<前缀>}

- 以a.b.c.d开始且前缀为x的所有IP地址均从对应的接口转发
- 连续IP地址，路由器转发表上仅对应为一个表项
- CIDR技术对于解决因特网路由器转发表空间急剧膨胀的问题至关重要

**子网掩码**

每个子网定义一个32位二进制数

![image-20200510201628062](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510201628062.png)

**作用**

获得主机子网地址
      IP地址 & 子网掩码 = 含子网号的网络地址
		 &：按位“与”运算
判断目标地址

- 设本地主机所在子网地址为Nx，子网掩码为Mx，远程主机的IP地址为IP y，再设Ny= IP y & Mx 
            若Nx==Ny，则认定远程主机与本地主机在同一子网上
            若Nx<>Ny，则认定远程主机与本地主机不在同一子网上

### 地址聚合，路由汇聚

> 前缀越短，包含地址数越多

1. CIDR将网络前缀都相同的连续的地址聚合成“CIDR地址块”

    ```sql
    例如，128.14.32.0/20表示的地址块有212个地址：
    128.14.32.0         10000000 00001110 00100000 00000000
    128.14.47.255       10000000 00001110 00101111 11111111 
    ```

2. 在路由表中利用CIDR地址块来表示目的网络，使得路由表中的一个项目可以表示很多个原来传统分类地址的路由，这称为路由聚合。

> 好处：大大压缩路由表项目数
> 注意：CIDR地址块中地址数必为2的整数幂

二叉线索路由表及最长前缀匹配

最长前缀匹配规则：前15bit和路由表第一项匹配，前17项与第二项匹配，则选择第二项

IPv4地址采用32bit，IPv6地址采用128bit，由网络号和主机号两部分组成。其中，网络号和主机号不允许为全0和全1。

# 网际协议（IP协议）

选路协议：RIP，OSPE，BGP

IP协议

- 编址规则
- 数据报格式
- 分组处理规则

ICMP协议

- 查错报告
- 路由协议

ARP&RARP协议：地址映射

## 数据报文格式（SDU）

首部检验和字段是根据IP首部计算的检验和码。它不对首部后面的数据进行计算。

- 生成：首先把检验和字段置为0，对首部中每个16 bit进行二进制反码求和，结果取反码存在检验和字段中。
- 鉴别：当收到一份IP数据报后，同样对首部中每个16 bit进行二进制反码的求和。

> ICMP、IGMP、UDP和TCP都采用相同的检验和算法。

![image-20200510192735672](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510192735672.png)

### 格式

三个涉及长度的字段：首部长度、总长度和片偏移。

- **首部**长度占用4bit，基本单位是4字节，最小值是5，最大值15，意味着IP首部长度最小20B，最大60B；
- **总长度**字段16bit，基本单位是1字节，最大值是65535；
- **片偏移**字段占用13bit，单位是8B，表示IP报文被分片后，每报片的数据长度必须是8字节的整数倍。

**生存周期**字段占8bit

> 其含义是该IP分组在网络中可以被转发的次数。

- IP分组每经过一个路由器的转发，该字段值减1，当某个路由器收到TTL字段值为0的分组时，将该分组丢弃，不再转发，同时向源主机发送ICMP差错报告。
- TTL的初始值在不同的操作系统中的定义是不同的。

**校验和字段采用二进制反码和**方法

- 仅计算首部校验和，这样可以提高转发速度。

### 分片与重装

> 网络链路有MTU(最大传输单元) ：一个**链路层帧**所能承载的最大数据量叫做MTU,不同的链路设计导致不同的MTU长度
>
> - 以太网：1500B，PPPoE（ADSL）：1492字节
> - FDDI协议：4352字节;

- 分片的**条件**：当一个分组从大的MTU链路转发到小的MTU链路必须要分片处理,否则或出错;
- 分片**操作的位置**：分片操作由连接两个链路的路由器完成;
- 分片**过程**：分片操作仅仅划分分组中的数据,每个片都被构造成一个完整的分组,片分组的头部信息从源分组获得,并作部分修改;
- **重新组装**: 分片后的重新组装在目的主机的网络层进行

#### 操作关键

**确定片的大小**：分片一定是对网络层分组的操作，片的大小由下面链路的MTU决定；

- 强调：报片本身也是一个分组，首部格式和分片前的分组一致；
- 片中的载荷数据长度一定是8字节的整数倍，否则片偏移无法计算；

**片数计算**：用原分组的载荷长度除以片的载荷长度

- 强调：分片分的是原分组中的数据，不包含首部；
- 计算每片的MF、DF和片偏移offset：DF一定都是0；
- MF除最后一片外其余各片中均为1；第一片的偏移值为0，第二片的偏移为本片中载荷长度除以8，第三片偏移是第二片的2倍，以后3倍，4倍类推；

**片的组装**：按照计算出的片大小，首先依次将原分组的数据装入各个片中，然后将原分组的首部加在各个片数据的前端，修改标志和片偏移字段，重新计算总长度和首部校验和，TTL减1。

#### 操作位置

分片可以发生在发送端主机上，也可以是中间路由器上

- 把一份IP数据报分片以后，只有到达目的地才进行重新组装。重新组装由目的端的IP层来完成。已经分片过的数据报有可能会再次进行分片（分片可能发生不止一次）。

**DHCP协议**

**工作过程**

1. 发现：如果客户机有一个永久性的租用地址，它可以直接请求那个地址。源IP为全0，目标IP全1
2. 提供：所有收到IP请求的服务器，会先分配设定的地址，若没有则从地址池中取出一个可用IP地址，并单播返回附有地址的Offer
3. 确认：客户机收到多个Offer会选择第1个或上次获得地址的服务器，并广播发送标识服务器的Request
4. 选择：被标识的服务器接收Request并单播返回DhcpAck，如果所请求的IP被分配则发回DhcpNak
5. 重新登录
    - 客户不需要再发送DHCP discover发现信息，而直接发送包含前一次所分配的IP地址（保存在存储器中，重启仍有效）的DHCP request请求信息。
    - 当DHCP服务器收到这一信息后，它会尝试让DHCP客户机继续使用原来的IP地址，并回答一个DHCP ack确认信息。 
6. 更新租约
    - 分配的IP地址都有一个租借期限，期满后DHCPServer便会收回出租的IP地址。如果DHCPClient要延长IP租约，必须更新地址租约。  
        - 租期为T，在0.5T时，Client发送DHCP Request报文要求更新。
        - 若服务器无响应Client会在0.875T时重新发送DHCP Request报文。

DHCP穿越路由器

- 配置路由器为DHCP Helper
- DHCP Helper以单播方式转发发现报文 

![image-20200510203054620](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510203054620.png)

IP**分组转发流程**

将每一个路由表项的子网掩码和分组目标IP“与”运算得出目的网络地址 N，N 与路由器直接相连，则是直接交付，否则是间接交付

##  ARP（地址解析协议）

LAN上的每个IP结点(主机、路由器)都有ARP表

- ARP表: 结点的IP/MAC地址映射
        < IP地址; MAC地址; TTL>
- TTL (寿命): 地址映射将被忘记的时间(常为20分钟)

**四种场景**

- 发送方是主机，要把IP数据报发送到**本网络**上的另一个主机。这时用 ARP 询问目的主机的硬件地址。 
- 发送方是主机，要把 IP 数据报发送到**另一个网络**上的一个主机。这时用 ARP 询问主机上默认网关的硬件地址。 
- 发送方是路由器，要把 IP 数据报转发到**本网络**上的一个主机。这时用 ARP 询问目的主机的硬件地址。 
- 发送方是路由器，要把 IP 数据报转发到**另一个网络**上的一个主机。这时用 ARP 询问路由器上查到下一跳路由器的硬件地址。

## ICMP

> （互联网控制报文协议）

ICMP(Internet Control Message Protocol)设计用于网络维护和管理

允许端系统或路由器报告差错情况，为网管人员提供适当的工具以查询网络结点的信息

由主机和路由器用于网络级信息的通信
- 差错报告：不可达主机，网络，端口, 协议
- 回声请求/回答 ( ping使用)

网络层“上面的” IP：IP 数据报携带ICMP 报文

**格式**

ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即类型、代码和检验和。接着的 4 个字节的内容与 ICMP 的类型有关。 

![image-20200510204521266](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510204521266.png)

**字段值**

![image-20200510204644215](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510204644215.png)

**报文类型**

- ICMP 差错报告报文
- ICMP 询问报文

差错报文

- 终点不可达 ：路由或主机不能交付报文
- 源点抑制：路由或主机因拥塞丢弃报文
- 时间超过 ：TTL值减为0；或终点在预定时间内不能收到一个报文的全部数据
- 参数问题 ：首部字段值不对
- 改变路由（重定向）：网络存在更好的路由时

不应发送差错报文的情况

- 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。
- 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。
- 对具有多播地址的数据报都不发送 ICMP 差错报告报文。
- 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。

## NAT

> 网络地址翻译NAT（Network Address Translation,RFC3022）

**使用场景**

-  主机没有全球唯一IP地址，需要连接互联网
- 更改服务提供者需重新拨号
- 互连的企业网络存在重复地址空间
- 需要使用简单的负载分担技术

在内部网络中使用内部的专有地址，通过NAT把专有地址翻译成因特网上合法的IP地址，在Internet上使用。

在内外网络接口处把IP数据报内的专有地址（内部本地）用合法的IP地址段（内部全局）来替换。 

**专有地址**

> 假如用户的广域网没有和I n t e r n e t或任何其他网络互联，那么IP地址可以任意选择。但是这被视为是缺乏远见和不负责任的行为。
> 1 9 9 3年RFC 1597发布，提出了一个解决冲突的计划。允许三个网络地址范围保留为内部网络使用。

保留为内部网络的三个范围分别包括在A、B、C类地址内

- 10.0.0.0 -10.255.255.255 （或记为10.0.0.0/8，它又称为24bit地址块）
- 172.16.0.0 – 172.31.155.155（或记为172.16.0.0/12 ,它又称为20bit地址块）
- 192.168.0.0 – 192.168.255.255（或记为192.168.0.0/16 ,它又称为16bit地址块）

 - 内部本地地址（Inside local address):分配给内部网络中一台主机的专用地址。
 - 内部全球地址（Inside global address):由地区因特网注册局或服务提供商分配的一个合法IP。
 - 外部本地地址(Outside Local address):  
 - 外部全局地址(Outside Global address):

**网络地址转换**

负责IP报文的目的地址的转换

# 路由选择

> 目的：决定从源到目的地通过网络的“好的路径(路由器序列)”
>
> 路由选择算法的图论抽象:、
>
> - 结点是路由器
> - 边是物理链路
> - 链路代价: 时延，费用或拥塞等级

**路由**：获得从一个网络到另一个网络方向的信息，可以一个路由器动态地交给另一个路由器，也可以由管理员静态的将这些方向分配给路由器。

## 分类

### 静态路由选择

管理员对目的地址和路由器端口之间的关系进行人工配置。只要网络拓扑改变，管理员必须手工更新这些信息。

非自适应的路由选择。

应用

- 当一个网络只有一条路径可以到达时，可以使用静态路由，避免了动态路由选择的开销。

### 动态路由选择

管理员输入配置命令启动动态路由选择后，动态路由选择协议可以主动地去发现路由。

自适应的路由选择。

### 分组转发关键技术

在静态路由中，路由表是由网络管理员人工写的，要注意：

1. 直接交付网络的下一跳必须是路由器的物理接口。
2. 间接交付网络的下一跳，必须是去往目的网络路线上的与本路由器直接相连邻居路由器的IP地址，而且这个地址是邻居在本路由器直连网络上的IP地址，即下一跳邻居路由器与本路由器直接相连端口的IP。
3. 为避免分组在网络中兜圈子，对于不是只有一个出口的末端网络的网关，路由器上不建议使用默认路由。

## 路由表构成

1. 初始化阶段—— 路由发现
    - 推导初始路由：直连网络=>直连路由
    - 无法推导部分：手工设置=>静态路由
        - 路由器间交换选路信息=> 动态路由
2. 维护阶段—— 路由更新（网络拓扑改变时）
    - 手工、静态更新
    - 路由协议自动、动态更新

## 路由选择算法

> 分布式和集中式

分散或全局的信息?
分散的: 

- 路由器知道物理相连的邻居，到邻居的链路费用
- 计算的迭代过程，与邻居交换信息
- “距离矢量” (distance-vector, DV)算法

全局的:

- 所有路由器具有完全的拓扑、链路费用信息
- “链路状态”算法(link state algorithm, LS)

### 动态路由算法

- 动态的分布式路路由选择协议
- 分层次的路由选择协议
    - 域内路由协议（interdomain routing），也称内部 网关协议IGP（interior gateway protocol）：自治系统AS内使用的路由协议，如RIP、OSPF
    - 域间路由协议（intradomain routing） ，也称外部网关协议EGP（exterior gateway protocol）：自治系统AS之间使用的路由协议，如BGP

### RIP

> 距离矢量路由选择算法，路由选择信息协议

- 距离矢量算法
- 包括在1982中的 BSD-UNIX Distribution
- 距离测度: 跳的数量(最大 = 15跳)

**特点**

- 仅与相邻路由器交换信息
- 交换本路由器路由选择表中的更新信息
- 按固定时间间隔交换信息，约30秒
- 根据更新信息，对本地RIP表进行处理

**问题**

- 如何获得网络连接信息？	答：与其他路由器交换信息
- 交换什么信息？	答：自己的路由表
- 和谁交换信息？	答：相邻的路由器
- 什么时候交换？	答：固定时间，e.g.每隔30秒
- 如何交换？	答：RIP报文

**目标**：跳数较少的为最佳路由

**算法**

如何计算最佳路由：距离向量算法  
Bellman-Ford算法要点：

修改接收的报文信息：下一跳为自己，距离加“1”，用修改后的报文信息更新自己的路由表

- 添加没有的新项目（新路径）
- 路径相同则更新（新消息）
- 路径不同保留最短路径（更优路径），超时（3分钟）修改“此路不通”

**问题**

- 链路费用变化:
- 好消息传播得快
- 坏消息传播得慢—“计数到无穷”问题!
- 在算法稳定前，反复迭代

解决办法

- 定义最大值（如16），防止计数到无穷大。
- 通过水平分割消除路由选择环路。

> 当一个路由器把路由选择的更新信息发送给一个相邻路由器时，它并不把从该邻居学习到的路由再回送给邻居。

![image-20200510212420777](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510212420777.png)

### OSPF

>  链路状态路由选择算法，开放最短路优先

“open”: 公共免费可用

使用链路状态(Link State)算法：网络拓扑和所有链路的费用都已知，可作为LS算法的输入

LS算法依靠两种机制进行路由计算：

- LS信息的可靠传输
- 积累的链路状态知识

#### 技术要点

- 使用洪泛链路状态信息的链路状态协议
- Dijkstra最低费用路径算法

#### 特色

- 安全性: 所有OSPF报文经鉴别(以防攻击) 
- 允许多条费用相同的路径(而RIP仅一条路径)
- 对每条链路，对不同的TOS(服务类型)，设置多种费用测度(如卫星链路费用置为用于尽力而服务为“低”，高为实时服务
- 综合的单播和多播支持: 
    - 多播OSPF (MOSPF)使用与OSPF相同的拓扑数据库
- 在大规模网络中，用层次的OSPF

#### OSPF快速收敛的保证：区域(Area)

在RIP协议中，

 - 网络是一个平面的概念，并无区域及边界等的定义。
 - 位于同一自制系统(AS)的路由器之间交换所有的信息。    

在OSPF路由协议中，

- 一个路由域可以划分为多个路由器群集，即一个AS被划分为多个编号的区域Area。区域不能相互重叠。
- 在一个区域的外部来看，该区域的拓扑结构和细节是不可见的。
- 每一个区域通过OSPF边界路由器相连，区域间可以通过路由总结（Summary）来减少路由信息，减小路由表，提高路由器的运算速度。

#### 层次OSPF

两级层次: 本地, 主干

- 链路状态通告仅在本地

每个结点具有详细的区域拓扑；仅知道到其他区域网络的方向(最短路)，区域边界路由器 : “摘要”到在自己区域网络的距离，向其他区域边界路由器通告

主干路由器 : 运行OSPF 路由选择限制到主干

边界路由器 : 连接到其他AS

#### 分组

##### 报文格式

![image-20200510213231239](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510213231239.png)

##### 5种分组类型

- 类型1：问候(Hello)分组, 在可能的相邻路由器之间建立通信。
- 类型2：数据库描述(Database Description)分组,两个路由器初始化连接时要交换数据库描述(DD)报文。这个报文类型用于描述，而非实际地传送OSPF路由器的链路-状态数据库内容。
- 类型3：链路状态请求(Link State Request)分组,于请求相邻路由器链路-状态数据库中的一部分数据。
- 类型4：链路状态更新(Link State Update)分组，对LSR的回应。
- 类型5：链路状态确认(Link State Acknowledgment)分组，可靠交换LSA的保证。

### RIP&OSPF比较

- OSPF 在维护路由表时比RIP使用较少的带宽。
- RIP基于跳数选路，有可能选择了很慢的路径。OSPF基于和带宽相关的度量进行选路。
- RIP简单，使用路由器的内存和处理器资源较少。
- OSPF选择最快的无环路径。
- RIP 最大跳数是16，限制了网络规模。
- RIP域中每个路由器只知道自己到达其他节点的度量，但不知道网络完整的拓扑信息。
- RIP在收到路由信息后要先更新自己的路由表才把路由信息发送出去，所以收敛速度慢。
- RIP使用平面拓扑。

### BGP和层次路由选择

AS互连

- 转发表由AS内部和AS之间的路由选择算法所配置
- AS内部设置内部目的地表项
- AS之间和AS内部对外部目的地设置表项

边界网关协议（BGP）是运行于 TCP 上的一种自治系统（AS）间的路由协议。 

BGP 是唯一用来处理像因特网大小的网络的协议，也是唯一能够处理好不相关路由域间的连接的协议。 

BGP 系统的主要功能是和其他的 BGP 系统交换网络可达信息。这些信息有效地构造了 AS 互联的拓朴图并由此清除了路由环路，同时在 AS 级别上可实施策略决策。

**BGP特征**

- 用属性（Attribute）描述路径，而不是用度量值；
    （距离矢量而非距离向量）
- 使用TCP（端口179）作为传输协议，继承了TCP的可靠性和面向连接的特性；
- 通过Keepalive信息来检验TCP的连接；
- 具有丰富的属性特征，方便实现基于策略的路由；
- 拥有自己的BGP表；
- 支持VLSM和CIDR；
- 适合在大型网络中使用。

**使用环境**‘

- 因特网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。
- 当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的，比较合理的做法是在 AS 之间交换“可达性”信息。   
- 自治系统之间的路由选择必须考虑有关策略。
    因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。 

**BGP-4使用4种报文**

- 打开(OPEN)报文，用来与相邻的另一个BGP发言人建立关系。
- 更新(UPDATE)报文，用来发送某一路由的信息，以及列出要撤消的多条路由。
- 保活(KEEPALIVE)报文，用来确认打开报文和周期性地证实邻站关系。
- 通知(NOTIFICATION)报文，用来发送检测到的差错。

在 RFC 2918 中增加了 ROUTE-REFRESH 报文，用来请求对等端重新通告。 

**BGP报文**

![image-20200510213905990](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510213905990.png)

**路径属性&BGP路径**

- 当通告一个前缀，通告中包括了BGP属性
    - 前缀 + 属性 = “路由”
- 两个重要的属性:
    - AS-PATH: 包含了对传递前缀的通告所经过的AS: AS 67 AS 17 
    - 下一跳: 指示了到下一跳的特定内部AS路由器(从当前AS到下一跳AS可能有多条链路)
- 当网关路由器接收了路由通告，使用输入策略来接受/拒绝

### 链路状态路由选择算法

Dijkstra算法

- 知道网络所有结点的拓扑、链路费用
    - 经“链路状态广播”
    - 所有结点具有相同信息
- 从一个结点(源)到所有其他结点计算最低费用路径
    - 给出对这些结点转发表
- 迭代: k次迭代后，得知到k个目的地的最低费用路径

> c(x,y): 从结点x到y的链路费用;  = ∞ 如果非直接邻居
>
> D(v):从源到目的地v路径费用的当前值
>
> p(v): 从源到v沿路径的前任结点
>
> N‘: 已知在最小费用路径中的结点集合
