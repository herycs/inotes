# TCP

## 认识

Transmission Control Protocol 传输控制协议

为了在不可靠的互联网络上提供可靠的端到端字节流而专门设计的一个传输协议。

IP层并不保证数据报一定被正确地递交到接收方，也不指示数据报的发送速度有多快。

IP负责接收和丢弃，TCP或者上层协议负责排序

特点：

- 可靠交付：依据建立的连接保证可靠的通信
- 流式数据：依据字节流处理数据收发
- 流量控制：网络状况不佳时尽量避免造成不必要的消耗
- 通信点对点：忽略网络中交接节点的操作，逻辑上实现一个可靠通道

TCP要求：

- 数据分片
- 到达确认
- 超时重发
- 滑动窗口
- 失序处理
- 重复处理
- 数据校验

## 特性

### 三次握手

>  syn提供建立连接的基础信息，同时表明当前为连接建立的资源已准备完成

syn

syn, ack

ack

整个过程中客户端和服务端状态

Client：listen -》syn_send-》established

Server：listen -》syn_receved -》established

为什么要有三次握手，二次可不可以，四次可不可以？

TCP连接目的是为了提供可靠的交互通道（逻辑上），双方都必须要确认收发都正常，那么对应到握手过程，syn -> Client发送没问题，syn, ack -> Client接收&Server发送没问题，ack->Server接收无问题。

故2次并不可以，但4次没必要

### 四次挥手

> fin表明在当前方向上的数据已发送完毕

fin

ack

data传输

fin

ack

整个过程中客户端和服务端状态

Client：established -》 fin_wait1 -》fin_wait2 -》time_out

Server：established -》close_wait -》last_ack -》closed

### 慢启动

每当建立一个TCP连接时或一个TCP连接发生超时重传后，该连接便进入慢启动阶段。进入慢启动后，TCP实体将拥塞窗口的大小初始化为一个报文段，即：cwnd=1。此后，每收到一个报文段的确认（ACK），cwnd值加1，即拥塞窗口按指数增加。当cwnd值超过慢启动阐值（sshterhs）或发生报文段丢失重传时，慢启动阶段结束。前者进入拥塞避免阶段，后者重新进入慢启动阶段。

所谓的慢启动门限就是说，当拥塞窗口超过这个门限的时候，就使用拥塞避免算法，而在门限以内就采用慢启动算法。所以这个标准才叫做门限，通常，拥塞窗口记做cwnd，慢启动门限记做ssthresh。

### 拥塞避免

在慢启阶段，当cwnd值超过慢启动阐值（ssthresh）后，慢启动过程结束，TCP连接进入拥塞避免阶段。在拥塞避免阶段，每一次发送的cwnd个报文段被完全确认后，才将cwnd值加1。在此阶段，cwnd值线性增加。

### 快速重传

快速重传是对超时重传的改进。当源端收到对同一个报文的三个重复确认时，就确定一个报文段已经丢失，因此立刻重传丢失的报文段，而不必等到重传定时器（RTO）超时。以此减少不必要的等待时间。

### 快速恢复

快速恢复是对丢失恢复机制的改进。在快速重传之后，不经过慢启动过程而直接进入拥塞避免阶段。每当快速重传后，置sshtesrh=cwnd/2、ewnd=ssthresh+3。此后，每收到一个重复确认，将cwnd值加1，直至收到对丢失报文段和其后若干报文段的累积确认后，置cwnd=ssthesrh，进入拥塞避免阶段。

## 使用

### 修改建立TCP连接的超时时间

l在主动端发送SYN后，如果被动端一直不回应SYN+ACK报文，主动端会不断的重传SYN报文直到超过一定的重传次数或超时时间。

l在主动端发送SYN后，被动端回应SYN+ACK报文，但主动端不再回复ACK，被动端也会一直重传直到超过一定的重传次数或超时时间。（SYN报文攻击会出现这种情况）

应对：可以通过以下命令配置SYN报文的超时时间（发送SYN报文到三次握手成功的最大时间），也就是建立TCP连接的超时时间。

### 修改缓冲区大小

TCP的接收缓冲区是用来缓存从对端接收到的数据，这些数据后续会被应用程序读取。一般情况下，TCP报文的窗口值反映接收缓冲区的空闲空间的大小。对于带宽比较大、有大批量数据的连接，增大接收缓冲区的大小可以显著提供TCP传输性能。

### 禁止端口不可达时的重置报文

TCP模块在分发TCP报文时，如果找不到该报文所属的TCP连接会主动回复一个reset报文以终止对端的TCP连接。攻击者可能利用大量的端口不可达的TCP报文对设备进行攻击。

可以使用以下命令禁止/恢复在收到端口不可达的TCP报文时发送reset报文。

### 限制TCP连接的MSS的最大值

MSS是最大传输段大小的缩写，指一个TCP报文的数据载荷的最大长度，不包括TCP选项。

在TCP建立连接的三次握手中，有一种很重要的工作那就是进行MSS协商。连接的双方都在SYN报文中增加MSS选项，其选项值表示本端最大能接收的段大小，即对端最大能发送的段大小。连接的双方取本端发送的MSS值和接收对端的MSS值的较小者作为本连接最大传输段大小。

l非直连网络中：mss = 默认值536。

l直连网络中：mss = 对端ip地址对应的出口的MTU - 20字节ip头 - 20字节tcp头。

### 启用PMTU发现功能

TCP的路径最大传输单元（PMTU）发现功能是按RFC1191实现的，这个功能可以提高网络带宽的利用率。当用户使用TCP来批量传输大块数据时，该功能可以使传输性能得到明显提升。

### 设置接口收发SYN报文的MSS选项值

当客户端发起一个TCP连接时，它通过TCP SYN报文中的MSS选项字段协商TCP报文数据载荷的最大值，客户端SYN报文的MSS值表示后续服务器端发送TCP报文数据载荷的最大值，反之同理。

## 其他

### 环回测试

发送出去还会回来

利用环回测试可以让路由器认为是由另外一个IP发起的请求（本地IPA---》NAT地址---》NAT发送给路由器），经过NAT接手后报文就是从NAT发出的

### 路径最大：MTU

MTU在发送时鉴定大小

### 滑动窗口



### 首部字段

选项：4位，每一位表示4位，共计64位

TTL避免发生环路情况下不断的发送

8位协议：ICMP 1， TCP 6， UDP 17

### 2MSL时延

MSL-》Maximum Segment Lifetime

如果前一次连接的某些数据仍然滞留在网络中，这些延迟数据在建立新连接之后才到达Server，由于新连接和老连接的端口号是一样的，又因为TCP协议判断不同连接的依据是socket pair，于是，TCP协议就认为那个延迟的数据是属于新连接的，这样就和真正的新连接的数据包发生混淆了。

### TCP数据流

交互数据流

成块数据流

对于FTP这样对于数据吞吐量有较高要求的要求，将总是希望每次尽量多的发送数据到对方主机，就算是有点“延迟”也无所谓。TCP也提供了一整套的策略来支持这样的需求。TCP协议中有16个bit表示“窗口”的大小，这是这些策略的核心。

### TCP超时重传

超时时间的计算是超时的核心部分，TCP要求这个算法能大致估计出当前的网络状况，虽然这确实很困难。要求精确的原因有两个：(1)定时长久会造成网络利用率不高。(2)定时太短会造成多次重传，使得网络阻塞。所以，书中给出了一套经验公式，和其他的保证计时器准确的措施。

### TCP定时器

一个连接中，有且仅有一个测量定时器被使用。也就是说，如果TCP连续发出3组数据，只有一组数据会被测量。

坚持定时器

用于防止通告窗口为0以后双方互相等待死锁的情况
坚持定时器的原理是简单的，当TCP服务器收到了客户端的0滑动窗口报文的时候，就启动一个定时器来计时，并在定时器溢出的时候向向客户端查询窗口是否已经增大，如果得到非零的窗口就重新开始发送数据，如果得到0窗口就再开一个新的定时器准备下一次查询。通过观察可以得知，TCP的坚持定时器使用1，2，4，8，16……64秒这样的普通指数退避序列来作为每一次的溢出时间。

保活定时器

保活定时器更加的简单，还记得FTP或者Http服务器都有Sesstion Time机制么？因为TCP是面向连接的，所以就会出现只连接不传送数据的“半开放连接”，服务器当然要检测到这种连接并且在某些情况下释放这种连接，这就是保活定时器的作用。其时限根据服务器的实现不同而不通。另外要提到的是，当其中一端如果崩溃并重新启动的情况下，如果收到该端“前生”的保活探察，则要发送一个RST数据报文帮助另一端结束连接。

### RTO

RTO 值源自于 RTT来计算，平滑过渡

当前值 = 0.9 {上一个估计值} + 0.1 {新测量值}

### TCP未来性能