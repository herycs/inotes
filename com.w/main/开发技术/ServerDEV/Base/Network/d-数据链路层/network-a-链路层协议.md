# 协议

## 流水线

> 流水线: 发送方允许发送多个、传输中、未应答的分组
>
> - 必须增加序号范围
> - 发送方和/或接收方设有缓冲

### 协议

- 回退N步（go-Back-N）,
- 选择性重传（S-R） 

### 概念

**发送窗口**：用来对发送端进行流量控制，而发送窗口的大小WT就代表在还没有收到对方确认信息的情况下发送端最多可以连续发送数据个数。

**接收窗口**：其大小WR代表可以连续接收的最多数据个数，窗内是当前欲接收的数据的发送序号（只有序号在窗口内的数据才可以接收，否则丢弃）。 
接收窗口驱动发送窗口的转动

### 问题

**问题**：滑动窗口序号不可无限增大

**处理**：滑动窗口的序号将随数据一起传送，显然不能无限制增大，当用k个比特对数据编号时，序号范围将在0～2k-1之间循环；

**问题**：序号与窗口的关系？

**应对**

协议是1分组1确认，即Wt =Wr=1，所以只要与前1分组序号能够区分即可，因此仅需1bit序号；
GNB协议为了保证仅按序接收显然Wr=1，那么Wt =？

同理对于SR，接收窗口必须最多和发送窗口一样大，且Wr ≤2k-1

对于滑动窗口协议，一般发送窗口大小+接收窗口大小=2k

### 具体实现

#### 滑动窗口

- 在分组首部需要K比特序号，2k=N
- “窗口”最大为N-1, 允许N个连续的没有应答分组

ACK(n): 确认序号**n-1**之前所有的分组，期待n号帧 - “累计ACK”

**问题**：可能收到重复的ACK

应对：对每个传输中的分组用同一个计时器timeout(n): 若超时，重传窗口中的分组n及所有更高序号的分组

#### 回退N步协议(Go-Back-N)

**概念**

- 接收方根据滑动窗口的序号按序接收分组
- 窗口中失序分组及后面将被丢弃
- 发送方采用**超时**机制来**重传**出现丢失或差错的分组及其以后未被确认的分组
- 接收方采用**累积确认**的方式
- GBN协议的接收窗口的长度为1

**特点**

- 在分组首部需要K比特序号，N=2k-1

- “窗口”最大为N

**问题及处理策略**

**问题**：效率问题

在按序接收问题上面处理过于简单，将导致大量正确数据的重复传送并被丢弃。影响协议效率，极端情况下效率可能低于停-等ARQ

应对：**选择重传**——SR协议

想要提高效率，可以扩大 接收窗口，先缓存失序但正确到达的分组，让发送方仅重传丢失或出错的分组，等到“落后”的分组到达接收方后再一起提交

选择性重传: 发送方/接收方窗口

## PPP协议

## 基础

> **1992** **年制订了** **PPP** **协议。经过** **1993** **年和** **1994** **年的修订，现在的** **PPP**协议已成为因特网的正式标准[RFC 1661][RFC2153]

## 地位

家庭主机到互联网的第一跳链路

## 组成

一个将 **IP 数据**报封装到**串行链路**的方法。

链路控制协议 LCP (Link Control Protocol)：一种扩展链路控制协议，用于建立、配置、测试和管理数据**链路连接**。

网络控制协议 NCP (Network Control Protocol)：协商该链路上所传输的**数据包**格式与类型，建立、配置不同的网络层协议

## 工作流程

当用户拨号接入 ISP 时：

（1）路由器的调制解调器**对拨号**做出**确认**，并**建立**一条**物理连接**（底层up）；

（2）**PC** 机向**路由器**发送一系列的 LCP 分组（封装成多个 PPP 帧）；

（3）这些分组及其响应选择一些 PPP 参数，和进行网络层配置（此前如有PAP或CHAP验证先要通过验证），NCP 给新接入的 PC机分配一个临时的 **IP** 地址，使 PC 机成为因特网上的一个主机；

（4）通信完毕时，NCP 释放网络层连接，**收回**原来分配出去的 **IP** 地址。接着，LCP **释放**数据**链路层连接**；

（5）最后**释放物理层**的连接。

## 帧格式

PPP是面向字节的，因而所有的PPP帧的长度都是整数个字节。

**格式**

```shell
标志字段 | 地址字段 | 控制字段 | 协议字段 | <--- 信息字段 ---> | 帧校验字段 | 标志字段
    1         1         1         2        不超过1500字节         2          1
```

协议字段定义参见RFC1700，它标识出网络层协议数据域的类型。.

- 0021：信息字段内容为IP数据报    

- C021：信息字段内容为PPP链路控制数据LCP

- 8021：信息字段内容为网络控制数据NCP

当PPP用在**同步传输链路**时，协议规定采用硬件来完成**比特**填充。

但当PPP用在**异步传输**时，它就使用**字节**填充，转义字符“0x7D”。

## 认证

### PAP认证方式

- 安全性相对**低**，password是**明文**传输，**两次握手**

    > **被叫**提出连接**请求**
    > **主叫响应**

### CHAP认证方式

- 安全性相对**高**，hash（哈希值）密码，**三次握手**

    > **主叫**发出**请求**
    >
    > **被叫**回复一个**数据包**，这个包里面有主叫发送的随机的哈希值
    >
    > **主叫**在数据库中**确认**无误后发送一个连接成功的数据包连接

# 有线LAN技术

### 多路访问链路和协议

> 局域网环境，密集端系统通常使用**多路访问**方式

### 应用场景

**信道资源紧缺，大量端系统或者频繁访问网络，或者以较小概率访问网络**

### 协议要求

- 共享单一广播信道

- 两个或更多结点并行传输--->相互干扰
    碰撞：如果结点同时接收到两个或更多信号

    多路访问协议

    - 该哪个结点发送数据？
    - 发送时会不会出现冲突？
    - 出现冲突怎么办？

共享信道的通信必须使用信道本身! 
不能用带外信道来协调

### 实现

**多路访问MAC协议**

**协议分类**

同一传输介质连接了多个站，而各站都是对等的，这就需要有一种仲裁方式来控制各站使用介质的方式，这就是介质访问控制（MAC）。

**信道划分**

> 静态FDM、TDM(帧长度125微秒)、、WDM、CDMA（**用户数量确定**）

- 特点：信道在用户通信时固定分配给用户，用户只要得到了信道就不会和别的用户发生冲突；信道利用率低。
- 改进：动态信道划分STDM

**动态媒体接入控制**（又称为多路访问(multiple access)）

> 信道并非在用户通信时固定分配给用户，**接入数量不确定**。

- 轮流访问：用户不能随机地发送信息而必须服从一定的控制，如令牌、轮询
- 随机接入：所有的用户可随机地发送信息：要解决媒体访问冲突的问题，如CSMA/CD

**协议特点**

**信道划分MAC协议**

- 在高负载时高效、公平地共享信道
- 低负载时低效：信道访问中延时，当1个活跃结点时，甚至仅有分配了 1/N 带宽! 

**随机访问MAC协议**

- 低负载是有效：单个结点能够全面利用信道
- 高负载：碰撞开销大

**轮流协议**

- 兼有两方面的优点!

随机访问协议

引出

大量结点以小概率发送分组

- 以信道全部速率R传输
- 结点间无优先权协调

两个或更多传输结点发送➜ “碰撞”(小概率)
随机访问MAC协议定义了: 

- 如何检测碰撞
- 如何从碰撞中恢复 (例如，经延迟后重新传输)

实例

- ALOHA
- 时隙ALOHA
- CSMA, CSMA/CD, CSMA/CA

**CSMA(载波侦听多路访问)**

> **发前先听**，听到忙时的等待策略：

- 非持续CSMA：一旦监听到信道忙，就不再监听；延迟一个随机时间后再次监听。
- 1-持续CSMA：监听到信道忙时，仍继续监听，直到信道空闲，一听到信道空闲就立即发送数据  。
- P-持续CSMA：适用于时隙信道，当听到信道空闲时，以概率p发送数据（以概率1-P延迟到下一时隙再发送）

**问题**

**CSMA****技术不能解决发送过程中出现的冲突现象**

**碰撞检测（CSMA/CD）**

**解决办法**

使用带冲突检测的载波监听多点访问CSMA/CD

**原理**

- **发送前**先监听信道是否空闲，若空闲则立即发送数据。
- **在发送时**，边发边继续监听。若监听到冲突，则立即停止发送。等待一段随机时间（称为退避）以后，再重新尝试。

CSMA/CD可概括为四句话：

- 先听后发 、 边听边发
- 冲突即停、 延迟重发

### 策略

**争用期**

显然，在使用CSMA/CD协议时，一个站不可能同时既发送又接收。因此使用CSMA/CD协议的以太网不可能进行全双工通信而只能进行双向交替通信(半双工通信)。

每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。这一特点称为**以太网发送的不确定性**。
发送数据帧期间，刚刚开始的一段时间是危险期。

**概念**

总线上**最晚**可以检测到冲突的时间为2τ，因此将此时间定义为以太网信道的争用期(contention period) ，又称为碰撞窗口(collision window) 

**最小帧长**

区分正常数据和碰撞的碎片

- 10M的以太网争用期取51.2μs，经过争用期的考验才能肯定数据发送是否成功。

解决办法

- 定义最短有效帧长 2τ×R, 51.2μs * 10M/s = 512bit = 64B

**冲突即停**

当发送数据的站一旦发现发生了碰撞时：

- 立即停止发送数据；
- 再继续发送若干比特的人为干扰信号(jamming signal)，以便让所有用户都知道现在已经发生了碰撞。

> 强化冲突信号: 确保所有的其他传输方都知道碰撞; 48 bit长

**延时重发**

TBEB： Truncated Binary Exponential Backoff,**截断二进制指数退避算法**

目标：估计当前负载，适应重传尝试

重负载: 随机等待时间更长

1. 确定基本退避时间，T0=2τ,最大冲突次数N；
2. 定义参数n，记录连续冲突次数；
3. 令k=Min[n，10]，从整数集合[0,1,2，…，(2k-1)]中随机取出一个数r，等待的时延为T=r* T0 ;
4. 当冲突次数n超过16次后，发送失败，丢弃传输的帧，发送错误报告。

### 效率

> - τ = 总线中最远2站点之间的传播时延
> - T0 =单帧最长发送时延
> - 随着τ趋于0, 效率趋于1，可能吗？
> - 随着T0趋于无穷大，效率趋于1

有碰撞多节点：E = 1 / (1 + 4.44𝜏 / T0)

无碰撞单节点：E =  1 / (1 + 𝜏 / T0)

# 以太网

•100Mbs网卡低于$10!

•率先广泛使用的LAN技术

•比令牌LAN和ATM等更简单、便宜

•在速率竞赛中取胜: 10 Mbps ~ 10 Gbps 

**拓扑**: 总线到星型

直到20世纪90年代，总线拓扑流行

> 目前星型拓扑流行，可靠性提高

- 中心为有源交换机（区分Hub和交换机结构）
- 每段单独运行以太网协议，此时结点相互没有碰撞(?)

### MAC地址

> 在局域网中，硬件地址又称为物理地址，或 MAC 地址。
> IEEE802 标准所说的“地址”严格地讲应当是每一个站的“名字”或标识符。 一个48bit的全局地址，与其物理位置无关。

### MAC结构

> IEEE的注册管理委员会RAC (Registration Authority Committee)是局域网全球地址的法定管理机构，它负责分配地址字段的六个字节中的前三个字节(即高位24 bit)。
> 世界上凡要生产局域网网卡的厂家都必须购买前三个字节构成的一个号(即地址块)，即机构惟一标识符OUI (Organizationally Unique Identifier)，通常也叫做公司标识符(company_id)。
> 地址字段中的后三个字节(即低位24 bit)由厂家自行指派，称为扩展标识符(extended identifier)，只要保证生产出的网卡没有重复地址即可。

**两种形式**：6B 全球范围 / 2B 单位范围

Ethernet地址 = Manufacture ID + NIC ID 
                                            24bit         24bit
   公司：Cisco    00-00-0c
              Novell   00-00-1B
                            00-00-D8
              3Com    00-20-AF
                            00-60-8C
               IBM     08-00-5A

适配器的MAC地址具有扁平(没有层次)结构，且保持不变

地址类型标识：地址字段的第一字节的最低位I/G   
    0 -- 单个站地址
    1 -- 组地址

地址范围标识：地址字段的第一字节的最低第二位U/L   
     0 -- 局部管理
     1 -- 全局管理

![image-20200510172436165](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510172436165.png)

PA : 前同步码 -  10101010序列，用于使接收方与发送方同步
SFD : 帧首定界 -- 10101011
DA: 目的地址 -- MAC 地址
SA: 源地址 -- MAC地址
LEN:数据长度（数据部分的字节数）（0-1500）（802.3 frame）
Type: 高层协议类型标识(≥1536） （ Ethernet V2 和 802.3 frame）
pad 填充字段，保证帧长不少于64字节
FCS : 帧校验序列（ CRC-32 ）

### 不可靠，无连接的服务

- 无连接: 在发送和接收适配器之间没有握手
- 不可靠: 接收适配器不向发送适配器发送应答或否定应答

> 传送给网络层的数据报流可能有丢包如果应用程序使用TCP，将能弥补丢包否则，应用程序将发现丢包

以太网的MAC协议：无时隙的CSMA/CD

### 无效MAC帧

数据字段的长度与长度字段的值不一致；
帧的长度不是整数个字节；
用收到的帧检验序列 FCS 查出有差错；
数据字段的长度不在 46 ~ 1500 字节之间。
有效的 MAC 帧长度为 64 ~ 1518 字节之间。
对于检查出的无效 MAC 帧就简单地丢弃。以太网不负责重传丢弃的帧。 

# 物理

### 集线器

> 物理层“哑”中继器 :

- 来自一条链路的比特从其他所有链路出去
- 与集线器连接的所有结点相互碰撞
- 无帧缓存
- 集线器无CSMA/CD : 适配器检测碰撞

### 交换机

> 链路层设备：比集线器智能化

存储并转发以太网帧（基于查表的转发和流量过滤）

- 当帧在网段上转发时，检查帧首部并基于MAC目的地址，选择性地向一个或多个出链路转发帧
- 当帧在网段上转发时，使用CSMA/CD 访问网段

即插即用, 自学习（基于自学习的转发表的构建）

- 交换机不必配置

透明性

- 主机不知道交换机的存在

### 网桥，以太网交换机

1. 接收帧
2. 缓存
3. 分析，查表
4. 丢弃发往同LAN的帧；否则转发到相应端口

### 交换机工作方式

工作原理归纳为：丢弃同网帧，转发异网帧，广播未知帧，学习源地址

### 帧转发过程

网桥的X端口收到一个来自站A去往站B的帧，则用帧目的地址B查询转发表中对应的端口

- 若目的端口与源端口X相同，则丢弃该帧；
- 目的端口与源端口X不同，则转发该帧；
- 目的端口未知，则向来**源X端口之外**各端口**广播**该帧，并通过逆向学习**更新**转发表。

**转发表的建立**

在转发过程中逆向学习，若**帧的源地址**A不在表中，则将该地址A及来源端口X对应插入到表中。

### 数据交换

在源和目的端口的数据交换：

存储转发方式－store & forward：收完整个数据帧，并在CRC校验通过之后，才能进行转发操作。

- 优点：有容错机制
- 缺点：延迟大小受帧长控制

直通方式－cut through：在接收数据帧时，一旦检测到目的地址就立即进行转发操作。

- 优点：转发不受帧长限制，低延迟
- 缺点：无校验，出错后浪费带宽

自由分段－Fragment-free：一旦检测到该数据帧不是冲突碎片，就进行转发操作。

- 优点：延迟介于1、2间
- 缺点：无校验，但出错几率低

### 链路层交换机特点

1. 无碰撞：每个接口是独立的碰撞域，各个接口之间互相不会冲突（非广播帧）
2. 异质的链路：各个接口可以具有不同的链路类型（不同的速率、介质、帧结构）
3. 便于管理
4. 更安全：流量隔离，不能嗅探
5. 不能隔离广播流量：所有端口存在于1个广播域

### 问题

Host X发送的帧导致以下问题：
广播风暴（图１）
多帧复制（图２）
转发表不稳定（图３）

**解决方法**

解决方法——生成树STP(Spanning Tree Protocol)

​    利用图论的原理，让网桥之间互相通信，用一棵连接每个LAN的生成树（Spanning Tree）覆盖实际的拓扑结构,形成一个无回路的网络。

交换机运行STP的过程

1. 检测并发现环路的存在（每隔2s广播BPDU）；
2. 将冗余链路的1条设为主链路，其余均为备用；
3. 通过阻塞某些备用链路来破环为树；
4. 只通过主链路交换流量；
5. 定期检查链路的情况，主链路出故障则启用备用链路。

# 虚拟局域网

> VLAN（Virtual Local Area Network）即虚拟局域网，是一种通过将局域网内的设备逻辑地而不是物理地划分成一个个网段从而实现虚拟工作组的新兴技术。
>
> IEEE于1999年颁布了用以标准化VLAN实现方案的802.1Q协议标准草案。

VLAN技术允许网络管理者将一个物理的LAN逻辑地划分成不同的广播域（或称虚拟LAN，即VLAN），每一个VLAN都包含一组有着相同需求的计算机工作站，与物理上形成的LAN有着相同的属性。

一个VLAN内部的广播和单播流量都不会转发到其他VLAN中，从而有助于控制流量、减少设备投资、简化网络管理、提高网络的安全性。 

### 以太帧格式

虚拟局域网协议允许在以太网的帧格式中插入一个 4 字节的标识符，称为 VLAN 标记(tag)，用来指明发送该帧的工作站属于哪一个虚拟局域网。 

### 构建技术

1. 基于端口的VLAN（最常用）
2. 基于MAC地址的VLAN（基于用户）
3. 基于协议的VLAN
4. 基于网络层地址的VLAN