# 网际协议（IP协议）

选路协议：RIP，OSPE，BGP

IP协议

- 编址规则
- 数据报格式
- 分组处理规则

ICMP协议

- 查错报告
- 路由协议

ARP&RARP协议：

- ARP：地址解析协议 IP-》MAC
- RARP：逆地址解析协议没有磁盘驱动器的系统使用

## 数据报文格式（SDU）

首部检验和字段是根据IP首部计算的检验和码。它不对首部后面的数据进行计算。

- 生成：首先把检验和字段置为0，对首部中每个16 bit进行二进制反码求和，结果取反码存在检验和字段中。
- 鉴别：当收到一份IP数据报后，同样对首部中每个16 bit进行二进制反码的求和。

> ICMP、IGMP、UDP和TCP都采用相同的检验和算法。

![image-20200510192735672](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510192735672.png)

### 格式

三个涉及长度的字段：首部长度、总长度和片偏移。

- **首部**长度占用4bit，基本单位是4字节，最小值是5，最大值15，意味着IP首部长度最小20B，最大60B；
- **总长度**字段16bit，基本单位是1字节，最大值是65535；
- **片偏移**字段占用13bit，单位是8B，表示IP报文被分片后，每报片的数据长度必须是8字节的整数倍。

**生存周期**字段占8bit

> 其含义是该IP分组在网络中可以被转发的次数。

- IP分组每经过一个路由器的转发，该字段值减1，当某个路由器收到TTL字段值为0的分组时，将该分组丢弃，不再转发，同时向源主机发送ICMP差错报告。
- TTL的初始值在不同的操作系统中的定义是不同的。

**校验和字段采用二进制反码和**方法

- 仅计算首部校验和，这样可以提高转发速度。

### 分片与重装

> 网络链路有MTU(最大传输单元) ：一个**链路层帧**所能承载的最大数据量叫做MTU,不同的链路设计导致不同的MTU长度
>
> - 以太网：1500B，PPPoE（ADSL）：1492字节
> - FDDI协议：4352字节;

- 分片的**条件**：当一个分组从大的MTU链路转发到小的MTU链路必须要分片处理,否则或出错;
- 分片**操作的位置**：分片操作由连接两个链路的路由器完成;
- 分片**过程**：分片操作仅仅划分分组中的数据,每个片都被构造成一个完整的分组,片分组的头部信息从源分组获得,并作部分修改;
- **重新组装**: 分片后的重新组装在目的主机的网络层进行

#### 操作关键

**确定片的大小**：分片一定是对网络层分组的操作，片的大小由下面链路的MTU决定；

- 强调：报片本身也是一个分组，首部格式和分片前的分组一致；
- 片中的载荷数据长度一定是8字节的整数倍，否则片偏移无法计算；

**片数计算**：用原分组的载荷长度除以片的载荷长度

- 强调：分片分的是原分组中的数据，不包含首部；
- 计算每片的MF、DF和片偏移offset：DF一定都是0；
- MF除最后一片外其余各片中均为1；第一片的偏移值为0，第二片的偏移为本片中载荷长度除以8，第三片偏移是第二片的2倍，以后3倍，4倍类推；

**片的组装**：按照计算出的片大小，首先依次将原分组的数据装入各个片中，然后将原分组的首部加在各个片数据的前端，修改标志和片偏移字段，重新计算总长度和首部校验和，TTL减1。

#### 操作位置

分片可以发生在发送端主机上，也可以是中间路由器上

- 把一份IP数据报分片以后，只有到达目的地才进行重新组装。重新组装由目的端的IP层来完成。已经分片过的数据报有可能会再次进行分片（分片可能发生不止一次）。

**DHCP协议**

**工作过程**

1. 发现：如果客户机有一个永久性的租用地址，它可以直接请求那个地址。源IP为全0，目标IP全1
2. 提供：所有收到IP请求的服务器，会先分配设定的地址，若没有则从地址池中取出一个可用IP地址，并单播返回附有地址的Offer
3. 确认：客户机收到多个Offer会选择第1个或上次获得地址的服务器，并广播发送标识服务器的Request
4. 选择：被标识的服务器接收Request并单播返回DhcpAck，如果所请求的IP被分配则发回DhcpNak
5. 重新登录
    - 客户不需要再发送DHCP discover发现信息，而直接发送包含前一次所分配的IP地址（保存在存储器中，重启仍有效）的DHCP request请求信息。
    - 当DHCP服务器收到这一信息后，它会尝试让DHCP客户机继续使用原来的IP地址，并回答一个DHCP ack确认信息。 
6. 更新租约
    - 分配的IP地址都有一个租借期限，期满后DHCPServer便会收回出租的IP地址。如果DHCPClient要延长IP租约，必须更新地址租约。  
        - 租期为T，在0.5T时，Client发送DHCP Request报文要求更新。
        - 若服务器无响应Client会在0.875T时重新发送DHCP Request报文。

DHCP穿越路由器

- 配置路由器为DHCP Helper
- DHCP Helper以单播方式转发发现报文 

![image-20200510203054620](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510203054620.png)

IP**分组转发流程**

将每一个路由表项的子网掩码和分组目标IP“与”运算得出目的网络地址 N，N 与路由器直接相连，则是直接交付，否则是间接交付

##  ARP（地址解析协议）

LAN上的每个IP结点(主机、路由器)都有ARP表

- ARP表: 结点的IP/MAC地址映射
        < IP地址; MAC地址; TTL>
- TTL (寿命): 地址映射将被忘记的时间(常为20分钟)

**四种场景**

- 发送方是主机，要把IP数据报发送到**本网络**上的另一个主机。这时用 ARP 询问目的主机的硬件地址。 
- 发送方是主机，要把 IP 数据报发送到**另一个网络**上的一个主机。这时用 ARP 询问主机上默认网关的硬件地址。 
- 发送方是路由器，要把 IP 数据报转发到**本网络**上的一个主机。这时用 ARP 询问目的主机的硬件地址。 
- 发送方是路由器，要把 IP 数据报转发到**另一个网络**上的一个主机。这时用 ARP 询问路由器上查到下一跳路由器的硬件地址。

## ICMP

> （互联网控制报文协议）

ICMP(Internet Control Message Protocol)设计用于网络维护和管理

允许端系统或路由器报告差错情况，为网管人员提供适当的工具以查询网络结点的信息

由主机和路由器用于网络级信息的通信

- 差错报告：不可达主机，网络，端口, 协议
- 回声请求/回答 ( ping使用)

网络层“上面的” IP：IP 数据报携带ICMP 报文

**格式**

ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即类型、代码和检验和。接着的 4 个字节的内容与 ICMP 的类型有关。 

![image-20200510204521266](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510204521266.png)

**字段值**

![image-20200510204644215](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510204644215.png)

**报文类型**

- ICMP 差错报告报文
- ICMP 询问报文

差错报文

- 终点不可达 ：路由或主机不能交付报文
- 源点抑制：路由或主机因拥塞丢弃报文
- 时间超过 ：TTL值减为0；或终点在预定时间内不能收到一个报文的全部数据
- 参数问题 ：首部字段值不对
- 改变路由（重定向）：网络存在更好的路由时

不应发送差错报文的情况

- 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。
- 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。
- 对具有多播地址的数据报都不发送 ICMP 差错报告报文。
- 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。

## NAT

> 网络地址翻译NAT（Network Address Translation,RFC3022）

**使用场景**

-  主机没有全球唯一IP地址，需要连接互联网
-  更改服务提供者需重新拨号
-  互连的企业网络存在重复地址空间
-  需要使用简单的负载分担技术

在内部网络中使用内部的专有地址，通过NAT把专有地址翻译成因特网上合法的IP地址，在Internet上使用。

在内外网络接口处把IP数据报内的专有地址（内部本地）用合法的IP地址段（内部全局）来替换。 

**专有地址**

> 假如用户的广域网没有和I n t e r n e t或任何其他网络互联，那么IP地址可以任意选择。但是这被视为是缺乏远见和不负责任的行为。
> 1 9 9 3年RFC 1597发布，提出了一个解决冲突的计划。允许三个网络地址范围保留为内部网络使用。

保留为内部网络的三个范围分别包括在A、B、C类地址内

- 10.0.0.0 -10.255.255.255 （或记为10.0.0.0/8，它又称为24bit地址块）
- 172.16.0.0 – 172.31.155.155（或记为172.16.0.0/12 ,它又称为20bit地址块）
- 192.168.0.0 – 192.168.255.255（或记为192.168.0.0/16 ,它又称为16bit地址块）

 - 内部本地地址（Inside local address):分配给内部网络中一台主机的专用地址。
 - 内部全球地址（Inside global address):由地区因特网注册局或服务提供商分配的一个合法IP。
 - 外部本地地址(Outside Local address):  
 - 外部全局地址(Outside Global address):

**网络地址转换**

负责IP报文的目的地址的转换