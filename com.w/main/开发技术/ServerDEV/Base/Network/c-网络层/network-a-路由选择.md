# 路由选择

> 目的：决定从源到目的地通过网络的“好的路径(路由器序列)”
>
> 路由选择算法的图论抽象:、
>
> - 结点是路由器
> - 边是物理链路
> - 链路代价: 时延，费用或拥塞等级

**路由**：获得从一个网络到另一个网络方向的信息，可以一个路由器动态地交给另一个路由器，也可以由管理员静态的将这些方向分配给路由器。

## 分类

### 静态路由选择

管理员对目的地址和路由器端口之间的关系进行人工配置。只要网络拓扑改变，管理员必须手工更新这些信息。

非自适应的路由选择。

应用

- 当一个网络只有一条路径可以到达时，可以使用静态路由，避免了动态路由选择的开销。

### 动态路由选择

管理员输入配置命令启动动态路由选择后，动态路由选择协议可以主动地去发现路由。

自适应的路由选择。

### 分组转发关键技术

在静态路由中，路由表是由网络管理员人工写的，要注意：

1. 直接交付网络的下一跳必须是路由器的物理接口。
2. 间接交付网络的下一跳，必须是去往目的网络路线上的与本路由器直接相连邻居路由器的IP地址，而且这个地址是邻居在本路由器直连网络上的IP地址，即下一跳邻居路由器与本路由器直接相连端口的IP。
3. 为避免分组在网络中兜圈子，对于不是只有一个出口的末端网络的网关，路由器上不建议使用默认路由。

## 路由表构成

1. 初始化阶段—— 路由发现
    - 推导初始路由：直连网络=>直连路由
    - 无法推导部分：手工设置=>静态路由
        - 路由器间交换选路信息=> 动态路由
2. 维护阶段—— 路由更新（网络拓扑改变时）
    - 手工、静态更新
    - 路由协议自动、动态更新

## 路由选择算法

> 分布式和集中式

分散或全局的信息?
分散的: 

- 路由器知道物理相连的邻居，到邻居的链路费用
- 计算的迭代过程，与邻居交换信息
- “距离矢量” (distance-vector, DV)算法

全局的:

- 所有路由器具有完全的拓扑、链路费用信息
- “链路状态”算法(link state algorithm, LS)

### 动态路由算法

- 动态的分布式路路由选择协议
- 分层次的路由选择协议
    - 域内路由协议（interdomain routing），也称内部 网关协议IGP（interior gateway protocol）：自治系统AS内使用的路由协议，如RIP、OSPF
    - 域间路由协议（intradomain routing） ，也称外部网关协议EGP（exterior gateway protocol）：自治系统AS之间使用的路由协议，如BGP

### RIP

> 距离矢量路由选择算法，路由选择信息协议

- 距离矢量算法
- 包括在1982中的 BSD-UNIX Distribution
- 距离测度: 跳的数量(最大 = 15跳)

**特点**

- 仅与相邻路由器交换信息
- 交换本路由器路由选择表中的更新信息
- 按固定时间间隔交换信息，约30秒
- 根据更新信息，对本地RIP表进行处理

**问题**

- 如何获得网络连接信息？	答：与其他路由器交换信息
- 交换什么信息？	答：自己的路由表
- 和谁交换信息？	答：相邻的路由器
- 什么时候交换？	答：固定时间，e.g.每隔30秒
- 如何交换？	答：RIP报文

**目标**：跳数较少的为最佳路由

**算法**

如何计算最佳路由：距离向量算法  
Bellman-Ford算法要点：

修改接收的报文信息：下一跳为自己，距离加“1”，用修改后的报文信息更新自己的路由表

- 添加没有的新项目（新路径）
- 路径相同则更新（新消息）
- 路径不同保留最短路径（更优路径），超时（3分钟）修改“此路不通”

**问题**

- 链路费用变化:
- 好消息传播得快
- 坏消息传播得慢—“计数到无穷”问题!
- 在算法稳定前，反复迭代

解决办法

- 定义最大值（如16），防止计数到无穷大。
- 通过水平分割消除路由选择环路。

> 当一个路由器把路由选择的更新信息发送给一个相邻路由器时，它并不把从该邻居学习到的路由再回送给邻居。

![image-20200510212420777](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510212420777.png)

### OSPF

>  链路状态路由选择算法，开放最短路优先

“open”: 公共免费可用

使用链路状态(Link State)算法：网络拓扑和所有链路的费用都已知，可作为LS算法的输入

LS算法依靠两种机制进行路由计算：

- LS信息的可靠传输
- 积累的链路状态知识

#### 技术要点

- 使用洪泛链路状态信息的链路状态协议
- Dijkstra最低费用路径算法

#### 特色

- 安全性: 所有OSPF报文经鉴别(以防攻击) 
- 允许多条费用相同的路径(而RIP仅一条路径)
- 对每条链路，对不同的TOS(服务类型)，设置多种费用测度(如卫星链路费用置为用于尽力而服务为“低”，高为实时服务
- 综合的单播和多播支持: 
    - 多播OSPF (MOSPF)使用与OSPF相同的拓扑数据库
- 在大规模网络中，用层次的OSPF

#### OSPF快速收敛的保证：区域(Area)

在RIP协议中，

 - 网络是一个平面的概念，并无区域及边界等的定义。
 - 位于同一自制系统(AS)的路由器之间交换所有的信息。    

在OSPF路由协议中，

- 一个路由域可以划分为多个路由器群集，即一个AS被划分为多个编号的区域Area。区域不能相互重叠。
- 在一个区域的外部来看，该区域的拓扑结构和细节是不可见的。
- 每一个区域通过OSPF边界路由器相连，区域间可以通过路由总结（Summary）来减少路由信息，减小路由表，提高路由器的运算速度。

#### 层次OSPF

两级层次: 本地, 主干

- 链路状态通告仅在本地

每个结点具有详细的区域拓扑；仅知道到其他区域网络的方向(最短路)，区域边界路由器 : “摘要”到在自己区域网络的距离，向其他区域边界路由器通告

主干路由器 : 运行OSPF 路由选择限制到主干

边界路由器 : 连接到其他AS

#### 分组

##### 报文格式

![image-20200510213231239](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510213231239.png)

##### 5种分组类型

- 类型1：问候(Hello)分组, 在可能的相邻路由器之间建立通信。
- 类型2：数据库描述(Database Description)分组,两个路由器初始化连接时要交换数据库描述(DD)报文。这个报文类型用于描述，而非实际地传送OSPF路由器的链路-状态数据库内容。
- 类型3：链路状态请求(Link State Request)分组,于请求相邻路由器链路-状态数据库中的一部分数据。
- 类型4：链路状态更新(Link State Update)分组，对LSR的回应。
- 类型5：链路状态确认(Link State Acknowledgment)分组，可靠交换LSA的保证。

### RIP&OSPF比较

- OSPF 在维护路由表时比RIP使用较少的带宽。
- RIP基于跳数选路，有可能选择了很慢的路径。OSPF基于和带宽相关的度量进行选路。
- RIP简单，使用路由器的内存和处理器资源较少。
- OSPF选择最快的无环路径。
- RIP 最大跳数是16，限制了网络规模。
- RIP域中每个路由器只知道自己到达其他节点的度量，但不知道网络完整的拓扑信息。
- RIP在收到路由信息后要先更新自己的路由表才把路由信息发送出去，所以收敛速度慢。
- RIP使用平面拓扑。

### BGP和层次路由选择

AS互连

- 转发表由AS内部和AS之间的路由选择算法所配置
- AS内部设置内部目的地表项
- AS之间和AS内部对外部目的地设置表项

边界网关协议（BGP）是运行于 TCP 上的一种自治系统（AS）间的路由协议。 

BGP 是唯一用来处理像因特网大小的网络的协议，也是唯一能够处理好不相关路由域间的连接的协议。 

BGP 系统的主要功能是和其他的 BGP 系统交换网络可达信息。这些信息有效地构造了 AS 互联的拓朴图并由此清除了路由环路，同时在 AS 级别上可实施策略决策。

**BGP特征**

- 用属性（Attribute）描述路径，而不是用度量值；
    （距离矢量而非距离向量）
- 使用TCP（端口179）作为传输协议，继承了TCP的可靠性和面向连接的特性；
- 通过Keepalive信息来检验TCP的连接；
- 具有丰富的属性特征，方便实现基于策略的路由；
- 拥有自己的BGP表；
- 支持VLSM和CIDR；
- 适合在大型网络中使用。

**使用环境**‘

- 因特网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。
- 当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的，比较合理的做法是在 AS 之间交换“可达性”信息。   
- 自治系统之间的路由选择必须考虑有关策略。
    因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。 

**BGP-4使用4种报文**

- 打开(OPEN)报文，用来与相邻的另一个BGP发言人建立关系。
- 更新(UPDATE)报文，用来发送某一路由的信息，以及列出要撤消的多条路由。
- 保活(KEEPALIVE)报文，用来确认打开报文和周期性地证实邻站关系。
- 通知(NOTIFICATION)报文，用来发送检测到的差错。

在 RFC 2918 中增加了 ROUTE-REFRESH 报文，用来请求对等端重新通告。 

**BGP报文**

![image-20200510213905990](C:\Users\ANGLE0\AppData\Roaming\Typora\typora-user-images\image-20200510213905990.png)

**路径属性&BGP路径**

- 当通告一个前缀，通告中包括了BGP属性
    - 前缀 + 属性 = “路由”
- 两个重要的属性:
    - AS-PATH: 包含了对传递前缀的通告所经过的AS: AS 67 AS 17 
    - 下一跳: 指示了到下一跳的特定内部AS路由器(从当前AS到下一跳AS可能有多条链路)
- 当网关路由器接收了路由通告，使用输入策略来接受/拒绝

### 链路状态路由选择算法

Dijkstra算法

- 知道网络所有结点的拓扑、链路费用
    - 经“链路状态广播”
    - 所有结点具有相同信息
- 从一个结点(源)到所有其他结点计算最低费用路径
    - 给出对这些结点转发表
- 迭代: k次迭代后，得知到k个目的地的最低费用路径

> c(x,y): 从结点x到y的链路费用;  = ∞ 如果非直接邻居
>
> D(v):从源到目的地v路径费用的当前值
>
> p(v): 从源到v沿路径的前任结点
>
> N‘: 已知在最小费用路径中的结点集合