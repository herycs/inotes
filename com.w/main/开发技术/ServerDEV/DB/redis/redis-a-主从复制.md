# Redis集群

## 复制

### 旧版

同步 + 命令传播

同步：从-》主同步数据库状态

命令传播：主发生改变，传播命令给从服务器

#### 同步

客户端发送slaveof

执行，从服务器发送sync给主服务器

执行过程：

1. 从服务器发送sync
2. 主服务器收到bgsave，生成RDB，使用缓冲区记录RDB生成期间的执行命令
3. 主服务器响应**RDB文件**
4. 从服务器载入RDB文件
5. 主服务器发送**缓冲区命令**给从服务器

### 命令传播

同步完毕，更新新执行的指令给从服务器

### 缺陷

初次复制：之前从服务器未复制过，或者当前主服务器是新上任的

断线后重新复制：命令传播阶段网络问题导致中断，重连后继续复制（复制文件时RDB，但是是**全量复制**）

## 新版

psync 2.8开始

命令有两种模式，完整重同步和部分重同步

- 完整重同步处理初次复制
- 部分重同步处理断线后重复制情况

### 部分从同步

功能构成：

- 主、从服务器复制偏移量
- 主服务器复制积压缓冲区
- 服务器运行ID

### 复制偏移量

主服务器发送N字节数据后，偏移量+N

从服务器接收N字节数据后，偏移量+N

主从同步后偏移量总是一致的

### 复制积压缓冲区

定长FIFO队列，Def:1MB

主服务器复制积压缓冲区保存最近时间段执行的写命令

若从服务器发送psync后，

- offset在服务器该缓存区中则使用部分从同步
- 若offset不在该缓冲区中，则使用完整从同步

大小：主从断线后的平均时间s * 每秒写数据量（协议格式写命令长度总和）

### 服务运行ID

40个随机16进制字符组成，主要用于重连后检查是否是原主服务器，用于确定部分重同步还是完整重同步

## 命令实现

格式：slaveof [server id] [offset]

从服务器

- 未复制过或者执行过slaveof no one，复制时发送slaveof ? -1，请求完整从同步
- 部分重同步，slaveof [id] [offset]

主服务器

- 返回：+fullresync [id] [offset]，完整重同步
- 返回：+confinue，部分重同步
- 返回：-ERR，主服务器不支持psync命令（v < 2.8)

## 复制的实现

1. 设置主服务器地址&端口:slaveof [ip] [port]
2. 建立套接字
3. 发送ping，检查状态
    1. 回应部分则证明网络不佳，重新建立套接字
    2. 回应错误，暂无法处理，重新建立
    3. 从服务器读取到PONG，则正常，套接字OK
4. 身份验证
5. 发送端口信息：从服务器向主服务器发送端口信息
6. 同步：从服务器sync
7. 命令传播

## 心跳检测

从->主：replconf ack [replication_offset]

### 辅助min_slaves

可以配置当从服务器少于 n 个，延迟大于等于 m时拒绝执行写服务

